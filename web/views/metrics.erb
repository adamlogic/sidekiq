<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script type="text/javascript" src="<%= root_path %>javascripts/metrics.js"></script>

<h3><%= t('Metrics') %></h3>

<canvas
  id="metrics-chart"
  data-labels="<%= h Sidekiq.dump_json(@query_result.buckets) %>"
  data-series="<%= h Sidekiq.dump_json(@query_result.job_results.map { |(kls, jr)| [kls, jr.dig("series", "ms")] }.to_h) %>"
></canvas>

<h3>Top Jobs by Processed Count</h3>

<% job_results = @query_result.job_results.sort_by { |(kls, jr)| jr.totals["p"] }.reverse.first(10).to_h %>
<div class="table_container">
  <table class="table table-bordered table-striped table-hover">
    <tbody>
      <tr>
        <th><%= t('Name') %></th>
        <th><%= t('Processed') %></th>
        <th><%= t('ExecutionTime') %></th>
      </tr>
      <% if job_results.any? %>
        <% job_results.each do |(kls, jr)| %>
          <tr>
            <td><code><a href="<%= root_path %>metrics/<%= kls %>"><%= kls %></a></code></td>
            <td><%= jr.dig("totals", "p") %></td>
            <td><%= jr.dig("totals", "ms") %></td>
          </tr>
        <% end %>
      <% else %>
          <tr><td colspan=3><%= t("NoDataFound") %></td></tr>
      <% end %>
    </tbody>
  </table>
</div>

<h3>Top Jobs by Execution Time</h3>

<% job_results = @query_result.job_results.sort_by { |(kls, jr)| jr.totals["ms"] }.reverse.first(10).to_h %>
<div class="table_container">
  <table class="table table-bordered table-striped table-hover">
    <tbody>
      <tr>
        <th><%= t('Name') %></th>
        <th><%= t('Processed') %></th>
        <th><%= t('ExecutionTime') %></th>
      </tr>
      <% if job_results.any? %>
        <% job_results.each do |(kls, jr)| %>
          <tr>
            <td><code><a href="<%= root_path %>metrics/<%= kls %>"><%= kls %></a></code></td>
            <td><%= jr.dig("totals", "p") %></td>
            <td><%= jr.dig("totals", "ms") %></td>
          </tr>
        <% end %>
      <% else %>
          <tr><td colspan=3><%= t("NoDataFound") %></td></tr>
      <% end %>
    </tbody>
  </table>
</div>

<p>
Data from <%= @query_result.starts_at %> to <%= @query_result.ends_at %>
</p>
